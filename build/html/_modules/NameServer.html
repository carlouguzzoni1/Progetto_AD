<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NameServer &#8212; sym-DFS-project 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <script src="../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for NameServer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">rpyc.lib</span>
<span class="kn">from</span> <span class="nn">rpyc.utils.server</span> <span class="kn">import</span> <span class="n">ThreadedServer</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">rpyc</span>
<span class="kn">from</span> <span class="nn">bcrypt</span> <span class="kn">import</span> <span class="n">hashpw</span><span class="p">,</span> <span class="n">gensalt</span><span class="p">,</span> <span class="n">checkpw</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">rsa</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>
<span class="kn">from</span> <span class="nn">apscheduler.schedulers.background</span> <span class="kn">import</span> <span class="n">BackgroundScheduler</span>
<span class="kn">import</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">json</span>



<span class="c1"># Load configuration from file.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;nameserver_config.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="n">LOCKFILE_PATH</span>   <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;directories&#39;</span><span class="p">][</span><span class="s1">&#39;lockfile_path&#39;</span><span class="p">]</span>
<span class="n">DB_PATH</span>         <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;directories&#39;</span><span class="p">][</span><span class="s1">&#39;db_path&#39;</span><span class="p">]</span>
<span class="n">SERVER_HOST</span>     <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="s1">&#39;server_host&#39;</span><span class="p">]</span>
<span class="n">SERVER_PORT</span>     <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="s1">&#39;server_port&#39;</span><span class="p">]</span>
<span class="n">ROOT_PASSPHRASE</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;root_passphrase&#39;</span><span class="p">]</span>

<span class="c1"># NOTE: la passphrase è il meccanismo che consente ai root users di potersi</span>
<span class="c1">#       registrare come tali. La verifica della passphrase avviene lato-file</span>
<span class="c1">#       server e ha lo scopo di non permettere in nessun caso ad altri clients</span>
<span class="c1">#       di accedere alla registrazione di root users.</span>

<span class="n">K_REPLICAS</span>      <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_replicas&#39;</span><span class="p">]</span>                    <span class="c1"># Mantain K replicas.</span>
<span class="n">K_LEAST_LOADED</span>  <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;kll_policy&#39;</span><span class="p">]</span>                      <span class="c1"># K-least loaded policy.</span>
<span class="n">HB_TIMEOUT</span>      <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;timeouts&#39;</span><span class="p">][</span><span class="s1">&#39;heartbeat&#39;</span><span class="p">]</span>           <span class="c1"># Receive heart-beats every HB_TIMEOUT seconds.</span>
<span class="n">PR_TIMEOUT</span>      <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;timeouts&#39;</span><span class="p">][</span><span class="s1">&#39;replication&#39;</span><span class="p">]</span>         <span class="c1"># Start periodic replication every PR_TIMEOUT seconds.</span>
<span class="n">GC_TIMEOUT</span>      <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;timeouts&#39;</span><span class="p">][</span><span class="s1">&#39;garbage_collection&#39;</span><span class="p">]</span>  <span class="c1"># Start garbage collection every GC_TIMEOUT seconds.</span>
<span class="n">CC_TIMEOUT</span>      <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;timeouts&#39;</span><span class="p">][</span><span class="s1">&#39;consistency_check&#39;</span><span class="p">]</span>   <span class="c1"># Start consistency check every CC_TIMEOUT seconds.</span>



<span class="c1">##### RSA KEYS GENERATION #####</span>



<span class="c1"># NOTE: per le interazioni potenzialmente critiche tra client e server, ci si</span>
<span class="c1">#       serve di un sistema di verifica tramite token JWT. Il token è generato</span>
<span class="c1">#       per entrambi clients e file servers. La chiave segreta è RSA a 2048 bit.</span>
<span class="c1">#       La chiave pubblica è distribuita solo ai file servers, ed utilizzata da</span>
<span class="c1">#       name server e file servers per autenticare i token.</span>
<span class="c1">#       Entrambe le chiavi sono generate all&#39;avvio del name server.</span>

<span class="c1"># IMPROVE: si potrebbe implementare un sistema di rotazione delle chiavi.</span>

<span class="c1"># Generate private and public keys.</span>
<span class="n">PRIVATE_KEY</span>     <span class="o">=</span> <span class="n">rsa</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span>
    <span class="n">public_exponent</span>         <span class="o">=</span> <span class="mi">65537</span><span class="p">,</span>
    <span class="n">key_size</span>                <span class="o">=</span> <span class="mi">2048</span>
<span class="p">)</span>
<span class="n">PUBLIC_KEY</span>      <span class="o">=</span> <span class="n">PRIVATE_KEY</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

<span class="c1"># Convert keys to strings.</span>
<span class="n">PRIVATE_KEY</span>     <span class="o">=</span> <span class="n">PRIVATE_KEY</span><span class="o">.</span><span class="n">private_bytes</span><span class="p">(</span>
    <span class="n">encoding</span>                <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
    <span class="nb">format</span>                  <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">PrivateFormat</span><span class="o">.</span><span class="n">PKCS8</span><span class="p">,</span>
    <span class="c1"># No password for simplicity.</span>
    <span class="n">encryption_algorithm</span>    <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">NoEncryption</span><span class="p">()</span>           
    <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="n">PUBLIC_KEY</span>      <span class="o">=</span> <span class="n">PUBLIC_KEY</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span>
    <span class="n">encoding</span>                <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
    <span class="nb">format</span>                  <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">PublicFormat</span><span class="o">.</span><span class="n">SubjectPublicKeyInfo</span>
    <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>



<span class="c1">##### NAME SERVER CLASS #####</span>



<div class="viewcode-block" id="NameServerService">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService">[docs]</a>
<span class="k">class</span> <span class="nc">NameServerService</span><span class="p">(</span><span class="n">rpyc</span><span class="o">.</span><span class="n">Service</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the name server, which is the central node in the sym-DFS architecture.</span>
<span class="sd">    The name server is a singleton.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># NOTE: sqlite3 è di default in modalità &quot;serialized&quot;, ciò significa che si</span>
    <span class="c1">#       possono eseguire più thread in simultanea senza restrizioni.</span>
    <span class="c1">#       https://docs.python.org/3/library/sqlite3.html#sqlite3.threadsafety</span>
    <span class="c1">#       Il progetto si può estendere per supportare accesso concorrente al DB.</span>
    
    <span class="c1"># IMPROVE: per risparmiare codice si potrebbe trovare il modo di definire una</span>
    <span class="c1">#       funzione od un decoratore che nasconda i costrutti try-catch, esponendo</span>
    <span class="c1">#       solamente SQL queries e messaggi di errore.</span>
    
    <span class="n">_instance</span>           <span class="o">=</span> <span class="kc">None</span>              <span class="c1"># NameServerService active instance.</span>
    <span class="n">_lock_file</span>          <span class="o">=</span> <span class="n">LOCKFILE_PATH</span>     <span class="c1"># File used to lock the file server.</span>
    
    
    <span class="c1">##### DUNDER METHODS #####</span>
    
    
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new name server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># NOTE: questo meccanismo di lock serve a garantire l&#39;effettività del</span>
        <span class="c1">#       design pattern Singleton, dunque l&#39;esistenza di un solo name</span>
        <span class="c1">#       server per l&#39;intero sistema.</span>
        
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check if name server is already running.</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_lock_file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error: name server already running!&quot;</span><span class="p">)</span>
            
            <span class="c1"># Create a new name server.</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">NameServerService</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            
            <span class="c1"># Lock the name server.</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_lock_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;locked&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance</span>
    
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">SERVER_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">SERVER_PORT</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the name server.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            host (str): The hostname or IP address of the name server.</span>
<span class="sd">            port (int): The port number of the name server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">server_host</span>        <span class="o">=</span> <span class="n">host</span>              <span class="c1"># Host for the name server.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span>        <span class="o">=</span> <span class="n">port</span>              <span class="c1"># Port for the name server.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span>            <span class="o">=</span> <span class="n">DB_PATH</span>           <span class="c1"># Local path to the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kll_policy</span>         <span class="o">=</span> <span class="n">K_LEAST_LOADED</span>    <span class="c1"># K-least loaded policy.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span>       <span class="o">=</span> <span class="n">PRIVATE_KEY</span>       <span class="c1"># Private key for JWT tokens.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span>        <span class="o">=</span> <span class="n">PUBLIC_KEY</span>        <span class="c1"># Public key for JWT tokens.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_passphrase</span>   <span class="o">=</span> <span class="n">ROOT_PASSPHRASE</span>   <span class="c1"># Root passphrase for creating root users.</span>
        
        <span class="c1"># Generate a token for the name server.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span>              <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span>
            <span class="s2">&quot;ns&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name_server&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_database</span><span class="p">()</span>
    
    
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the lock file when the name server is deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shutting down name server...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Remove the lock file.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lock_file</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing lock file...&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lock_file</span><span class="p">)</span>
    
    
    <span class="c1">##### PRIVATE METHODS #####</span>
    
    
    <span class="k">def</span> <span class="nf">_setup_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the nameserver&#39;s database (if it doesn&#39;t exist) and initializes it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database already exists.&quot;</span><span class="p">)</span>
            
            <span class="k">return</span>
        
        <span class="c1"># Create the database.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating name server database...&quot;</span><span class="p">)</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Create users table.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TABLE IF NOT EXISTS users (</span>
<span class="s2">                    username TEXT PRIMARY KEY,</span>
<span class="s2">                    password_hash TEXT NOT NULL,</span>
<span class="s2">                    is_root BOOLEAN NOT NULL DEFAULT 0,</span>
<span class="s2">                    is_online BOOLEAN NOT NULL DEFAULT 0,</span>
<span class="s2">                    last_heartbeat TIMESTAMP</span>
<span class="s2">                );</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error creating users table:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        
        <span class="c1"># Create file servers table.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TABLE IF NOT EXISTS file_servers (</span>
<span class="s2">                    name TEXT PRIMARY KEY,</span>
<span class="s2">                    password_hash TEXT NOT NULL,</span>
<span class="s2">                    address TEXT NOT NULL,</span>
<span class="s2">                    port INTEGER NOT NULL,</span>
<span class="s2">                    is_online BOOLEAN NOT NULL DEFAULT 0,</span>
<span class="s2">                    size INTEGER NOT NULL,</span>
<span class="s2">                    free_space INTEGER NOT NULL,</span>
<span class="s2">                    last_heartbeat TIMESTAMP,</span>
<span class="s2">                    UNIQUE (address, port)</span>
<span class="s2">                );</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error creating file servers table:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        
        <span class="c1"># Create files table.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TABLE IF NOT EXISTS files (</span>
<span class="s2">                    file_path TEXT PRIMARY KEY,</span>
<span class="s2">                    file_name TEXT NOT NULL,</span>
<span class="s2">                    owner TEXT NOT NULL,</span>
<span class="s2">                    size INTEGER NOT NULL,</span>
<span class="s2">                    checksum TEXT NOT NULL,</span>
<span class="s2">                    primary_server TEXT NOT NULL,</span>
<span class="s2">                    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s2">                    is_corrupted BOOLEAN NOT NULL DEFAULT 0,</span>
<span class="s2">                    FOREIGN KEY (primary_server) REFERENCES file_servers (name),</span>
<span class="s2">                    FOREIGN KEY (owner) REFERENCES users (username)</span>
<span class="s2">                );</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error creating files table:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        
        <span class="c1"># Create replicas table.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TABLE IF NOT EXISTS replicas (</span>
<span class="s2">                    file_path TEXT NOT NULL,</span>
<span class="s2">                    server TEXT NOT NULL,</span>
<span class="s2">                    FOREIGN KEY (file_path) REFERENCES files (file_path),</span>
<span class="s2">                    FOREIGN KEY (server) REFERENCES file_servers (name),</span>
<span class="s2">                    PRIMARY KEY (file_path, server)</span>
<span class="s2">                );</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error creating replicas table:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>            
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database created.&quot;</span><span class="p">)</span>
    
    
    <span class="c1">##### ENTITY MANAGEMENT RPCs #####</span>
    
    
<div class="viewcode-block" id="NameServerService.exposed_create_user">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_create_user">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">is_root</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">root_passphrase</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new user.</span>
<span class="sd">        </span>
<span class="sd">        Args:   </span>
<span class="sd">            username (str):         The username of the new user.</span>
<span class="sd">            password (str):         The password of the new user.</span>
<span class="sd">            is_root (bool):         Whether the new user is a root user.</span>
<span class="sd">            root_passphrase (str):  The passphrase of the root user.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict:                   A dictionary containing the result of the operation</span>
<span class="sd">                                    and a message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">conn</span>            <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>          <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">gensalt</span><span class="p">())</span>
        
        <span class="c1"># Check if someone unauthorized is trying to create a root user.</span>
        <span class="k">if</span> <span class="n">is_root</span> <span class="ow">and</span> <span class="n">root_passphrase</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_passphrase</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Invalid root passphrase. Unauthorized action.&quot;</span>
            <span class="p">}</span>
        
        <span class="c1"># Create the user.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                INSERT INTO users (username, password_hash, is_root, is_online)</span>
<span class="sd">                VALUES (?, ?, ?, ?)</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">,</span> <span class="n">is_root</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; created successfully.&quot;</span>
            <span class="p">}</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error creating user:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error: user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; already exists.&quot;</span>
                <span class="p">}</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_create_file_server">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_create_file_server">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_create_file_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new file server.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name (str):     The name of the new file server.</span>
<span class="sd">            password (str): The password of the new file server.</span>
<span class="sd">            host (str):     The host of the new file server.</span>
<span class="sd">            port (int):     The port of the new file server.</span>
<span class="sd">            size (int):     The size of the new file server.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            str:            A message indicating the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">conn</span>            <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>          <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">gensalt</span><span class="p">())</span>
        
        <span class="c1"># Verify that there are no conflicts with the name server.</span>
        <span class="k">if</span> <span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;localhost&quot;</span> <span class="ow">or</span> <span class="n">host</span> <span class="o">==</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: File server port </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> conflicts with name server port.&quot;</span>
        
        <span class="c1"># Create the file server.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO file_servers (name, password_hash, address, port, size, free_space)</span>
<span class="s2">                VALUES (?, ?, ?, ?, ?, ?)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;File server &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created successfully.&quot;</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error creating file server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: file server &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already exists.&quot;</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_authenticate_user">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_authenticate_user">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_authenticate_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticates a user and sends back a JWT token.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            username (str): The username of the user.</span>
<span class="sd">            password (str): The password of the user.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict:           A dictionary containing the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># NOTE: sia la creazione che l&#39;autenticazione di un utente root o regolare</span>
        <span class="c1">#       vengono fatte dalle stesse funzioni (per semplicità e risparmio di</span>
        <span class="c1">#       codice). Nella creazione ci siamo serviti della passphrase per</span>
        <span class="c1">#       assicurare un minimo di sicurezza. In questo caso supponiamo</span>
        <span class="c1">#       semplicemente che chi tenta di autenticarsi come root debba conoscere</span>
        <span class="c1">#       le credenziali.</span>
        
        <span class="c1"># IMPROVE: per rendere il progetto più sicuro si potrebbe implementare un</span>
        <span class="c1">#       numero massimo di tentativi di accesso.</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get user online status, hashed password and root status.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT is_online, password_hash, is_root</span>
<span class="s2">                FROM users</span>
<span class="s2">                WHERE username = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">result</span>  <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error selecting record for user:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error authenticating user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1">### Check whether login can&#39;t be done.</span>
        
        <span class="c1"># Check user existence. User must exist.</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error: user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1"># Check user online status. User must not be online.</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error: user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; already logged in.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1"># Check user password validity. Password must be correct.</span>
        <span class="n">password_match</span> <span class="o">=</span> <span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password_match</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error: wrong password for user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1">### If the above checks are passed:</span>
        
        <span class="c1"># Check user root status. Create a token depending on the root status.</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span><span class="p">)</span>
        
        <span class="c1"># Try to update user online status.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE users</span>
<span class="s2">                SET is_online = 1,</span>
<span class="s2">                last_heartbeat = CURRENT_TIMESTAMP</span>
<span class="s2">                WHERE username = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; authenticated successfully.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;token&quot;</span><span class="p">:</span>    <span class="n">token</span>
                <span class="p">}</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating record for user:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error authenticating user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_authenticate_file_server">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_authenticate_file_server">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_authenticate_file_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticates a file server.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name (str):     The name of the file server.</span>
<span class="sd">            password (str): The password of the file server.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict:           A dictionary containing the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get file server online status, hashed password, address and port.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT is_online, password_hash, address, port</span>
<span class="s2">                FROM file_servers</span>
<span class="s2">                WHERE name = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">result</span>  <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error selecting record for file server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error connecting to the database.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1">### Check whether login can&#39;t be done.</span>
        
        <span class="c1"># Check file server existence. File server must exist.</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error: file server &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1"># Check file server online status. File server must not be online.</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error: file server &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; already logged in.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1"># Check file server password validity. Password must be correct.</span>
        <span class="n">password_match</span> <span class="o">=</span> <span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password_match</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error: wrong password for file server &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1">### If the above checks are passed:</span>
        
        <span class="c1"># Generate a token.</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;file_server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_private_key</span><span class="p">)</span>
        
        <span class="c1"># Try to update file server online status.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE file_servers</span>
<span class="s2">                SET is_online = 1,</span>
<span class="s2">                last_heartbeat = CURRENT_TIMESTAMP</span>
<span class="s2">                WHERE name = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>       <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>      <span class="sa">f</span><span class="s2">&quot;File server &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; authenticated successfully.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;host&quot;</span><span class="p">:</span>         <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s2">&quot;port&quot;</span><span class="p">:</span>         <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                <span class="s2">&quot;token&quot;</span><span class="p">:</span>        <span class="n">token</span><span class="p">,</span>
                <span class="s2">&quot;public_key&quot;</span><span class="p">:</span>   <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span>
                <span class="p">}</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error updating record for file server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error connecting to the database.&quot;</span>
                <span class="p">}</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_delete_user">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_delete_user">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes a user.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            username (str): The username of the user.</span>
<span class="sd">            password (str): The password of the user.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            str:            A message indicating the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># TEST: cancellazione utente con files.</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get user root status, hashed password and online status.</span>
        <span class="k">try</span><span class="p">:</span>            
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT is_root, password_hash, is_online</span>
<span class="s2">                FROM users</span>
<span class="s2">                WHERE username = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error selecting record for user:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error deleting user.&quot;</span>
        
        <span class="c1"># Check user existence. User must exist.</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
        
        <span class="c1"># Check user root status. User must not be root.</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: you don&#39;t have the needed permissions to delete user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        
        <span class="c1"># Check user online status. User must not be online.</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; is currently logged in.&quot;</span>
        
        <span class="c1"># Check user password validity. Password must be correct.</span>
        <span class="n">password_match</span> <span class="o">=</span> <span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password_match</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: wrong password for user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        
        <span class="c1"># Delete the user and his/her files and replicas.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                DELETE FROM users WHERE username = ?</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                DELETE FROM files WHERE owner = ?</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                DELETE FROM replicas WHERE owner = ?</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; deleted successfully.&quot;</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error while deleting user:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="s2">&quot;Error deleting user </span><span class="si">{username}</span><span class="s2">.&quot;</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_logout_user">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_logout_user">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_logout_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs out an entity.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            token (str):    The JWT token of the client.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            str:            A message indicating the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">conn</span>        <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>      <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get the username from the token.</span>
        <span class="n">payload</span>     <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error logging out. Corrupted token.&quot;</span>
        
        <span class="n">username</span>    <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        
        <span class="c1"># Update the client online status.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE users</span>
<span class="s2">                SET is_online = 0</span>
<span class="s2">                WHERE username = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; logged out successfully.&quot;</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error updating record for user:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error logging out user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
    
<div class="viewcode-block" id="NameServerService.exposed_logout_file_server">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_logout_file_server">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_logout_file_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs out a file server.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            token (str):    The JWT token of the file server.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            str:            A message indicating the result of the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">conn</span>        <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>      <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get the username and the role from the token.</span>
        <span class="n">payload</span>     <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error logging out. Corrupted token.&quot;</span>
        
        <span class="n">username</span>    <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE file_servers</span>
<span class="s2">                SET is_online = 0</span>
<span class="s2">                WHERE name = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;File server &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; logged out successfully.&quot;</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error updating record for file server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error logging out file server &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
    <span class="c1">##### BASIC CLIENT RPCs #####</span>
    
    
<div class="viewcode-block" id="NameServerService.exposed_get_user_files">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_get_user_files">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_get_user_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the files owned by a user for visualization purposes.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            token (str):    The JWT token of the user.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            list:           A list of dictionaries containing the file information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get the username from the token.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Error getting user files. Corrupted token.&quot;</span>
                <span class="p">}</span>
        
        <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        
        <span class="c1"># Get the files owned by the user.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT file_path, size, is_corrupted, uploaded_at, primary_server</span>
<span class="s2">                FROM files</span>
<span class="s2">                WHERE owner = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">username</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            
            <span class="c1"># Check whether the user has any files.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;User &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; has no files.&quot;</span>
                    <span class="p">}</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Files for user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; retrieved successfully.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;files&quot;</span><span class="p">:</span>    <span class="n">result</span>
                <span class="p">}</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting record for user:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error retrieving files for user &#39;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_get_file_server_upload">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_get_file_server_upload">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_get_file_server_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="n">checksum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the best file server to store a client&#39;s file according to K-least</span>
<span class="sd">        loaded policy. In this case load is the free space of the file server.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            token (str):        The JWT token of the user.</span>
<span class="sd">            file_path (str):    The absolute file path in the DFS.</span>
<span class="sd">            file_size (int):    The size of the file.</span>
<span class="sd">            checksum (str):     The checksum of the file.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict:               A dictionary containing the file server information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Get the username from the token.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error getting user files. Corrupted token.&quot;</span>
                <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        
        <span class="c1"># Verify that the first directory has the same name as the username.</span>
        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error sending file. Base directory does not match username.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1"># Verify that the file path does not contain any &#39;..&#39;.</span>
        <span class="k">if</span> <span class="s2">&quot;..&quot;</span> <span class="ow">in</span> <span class="n">file_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error sending file. Invalid file path.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1"># Get the file&#39;s name.</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get the K least loaded file servers.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT name, address, port, free_space</span>
<span class="s2">                FROM file_servers</span>
<span class="s2">                WHERE is_online = 1</span>
<span class="s2">                ORDER BY free_space DESC</span>
<span class="s2">                LIMIT ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kll_policy</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error selecting record for file server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error getting best file server for file &#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1"># Check if there is any file server available.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;No file server available for file &#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">}</span>
        
        <span class="c1"># Select the best file server randomly.</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">best_file_server</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Iterate through the file servers to find the first one with enough free space.</span>
        <span class="k">for</span> <span class="n">file_server</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_server</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">file_size</span><span class="p">:</span>
                <span class="n">best_file_server</span> <span class="o">=</span> <span class="n">file_server</span>
                <span class="k">break</span>
        
        <span class="c1"># If no file server has enough free space, return an error message.</span>
        <span class="k">if</span> <span class="n">best_file_server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;No file server has enough free space for file &#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">}</span>
        
        <span class="c1"># Update the file server&#39;s free space.        </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE file_servers</span>
<span class="s2">                SET free_space = ?</span>
<span class="s2">                WHERE name = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">best_file_server</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">file_size</span><span class="p">,</span> <span class="n">best_file_server</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error updating record for file server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error updating file server for file &#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1"># Create new entry into the files table.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO files (file_path, file_name, owner, size, checksum, primary_server)</span>
<span class="s2">                VALUES (?, ?, ?, ?, ?, ?)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="n">checksum</span><span class="p">,</span> <span class="n">best_file_server</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inserting record for file:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error creating for file &#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1"># Create a new entry into the replicas table.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO replicas (file_path, server)</span>
<span class="s2">                VALUES (?, ?)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">best_file_server</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Best file server found.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;host&quot;</span><span class="p">:</span>     <span class="n">best_file_server</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;port&quot;</span><span class="p">:</span>     <span class="n">best_file_server</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">}</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inserting record for replica of file:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error creating replica for file &#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_get_file_server_download">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_get_file_server_download">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_get_file_server_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the primary server for a client which wants to download a file.</span>
<span class="sd">        In case the primary file server is offline, the first online file server</span>
<span class="sd">        available is returned.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            file_path (str):    The absolute file path in the DFS.</span>
<span class="sd">            token (str):        The JWT token of the requestor.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict:               A dictionary containing the file server information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TEST: download file da server primario e non.</span>
        
        <span class="c1"># Get the username from the token.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error getting file server. Corrupted token.&quot;</span>
                <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get host and port of the primary file server for the file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT f.primary_server, fs.address, fs.port</span>
<span class="s2">                FROM files AS f</span>
<span class="s2">                JOIN file_servers AS fs ON f.primary_server = fs.name</span>
<span class="s2">                WHERE f.file_path = ?</span>
<span class="s2">                AND f.owner = ?</span>
<span class="s2">                AND fs.is_online = 1</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting record for file:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error getting file server for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
        
        <span class="c1"># If the primary file server is available, return its information.</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Primary server found.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;host&quot;</span><span class="p">:</span>     <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;port&quot;</span><span class="p">:</span>     <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">}</span>
        
        
        <span class="c1"># If not, look for an online file server to download the file.        </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT fs.name, fs.address, fs.port</span>
<span class="s2">                FROM files AS f</span>
<span class="s2">                JOIN replicas AS r ON f.file_path = r.file_path</span>
<span class="s2">                JOIN file_servers AS fs ON r.server = fs.name</span>
<span class="s2">                WHERE file_path = ?</span>
<span class="s2">                AND fs.is_online = 1</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting record for replica of file:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Error getting file server for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">}</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># If an online file server is available, return its information.</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Online file server found.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;host&quot;</span><span class="p">:</span>     <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;port&quot;</span><span class="p">:</span>     <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">}</span>
        
        <span class="c1"># If no file server is available, return an error message.</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find an available file server for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">}</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_delete_file">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_delete_file">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_delete_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes a file from the DFS.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            file_path (str):    The path of the file in the DFS.</span>
<span class="sd">            token (str):        The token of the requestor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># NOTE: la cancellazione di un file, come la cancellazione di un utente,</span>
        <span class="c1">#       avviene solo lato-name server (più precisamente nel database).</span>
        <span class="c1">#       I files vengono effettivamente cancellati dai file servers</span>
        <span class="c1">#       tramite un meccanismo periodico di garbage cleaning.</span>
        
        <span class="c1"># TEST: cancellazione di un file con i nuovi meccanismi di replica e</span>
        <span class="c1">#       garbage cleaning attivi.</span>
        
        <span class="c1"># Get the username from the token.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error deleting file. Corrupted token.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Delete the file from the replicas table. </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                DELETE FROM replicas</span>
<span class="s2">                WHERE file_path = ?</span>
<span class="s2">                AND ? = (</span>
<span class="s2">                    SELECT owner</span>
<span class="s2">                    FROM files</span>
<span class="s2">                    WHERE file_path = ?</span>
<span class="s2">                )</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting record for replica of file:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error deleting replicas of file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        
        <span class="c1"># Delete the file from the files table.        </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                DELETE FROM files</span>
<span class="s2">                WHERE file_path = ?</span>
<span class="s2">                AND owner = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting record for file:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error deleting file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; deleted.&quot;</span></div>

    
    
    <span class="c1">##### ROOT CLIENT RPCs #####</span>
    
    
<div class="viewcode-block" id="NameServerService.exposed_exists_root_user">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_exists_root_user">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_exists_root_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether there is a root user in the name server&#39;s database.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if there is a root user, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">conn</span>        <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>      <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT is_root</span>
<span class="s2">                FROM users</span>
<span class="s2">                WHERE is_root = 1</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">result</span>  <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error selecting record for user:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="kc">False</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_list_all_files">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_list_all_files">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_list_all_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lists all files in the DFS. For root clients use only.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            token (str):    The token of the requestor.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict:           A dictionary with the status and the list of files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># TEST: lista di tutti i files con un file corrotto nel database.</span>
        
        <span class="c1"># Get the client&#39;s role from the token.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Error listing files. Corrupted token.&quot;</span>
                <span class="p">}</span>
        
        <span class="n">role</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
        
        <span class="c1"># Check the role of the requestor. It must be root.</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Error listing files. Only admin can list files.&quot;</span>
                <span class="p">}</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get the metadata of all files in the DFS.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT f.file_path, f.size, f.owner, f.checksum, f.is_corrupted, f.uploaded_at, r.server</span>
<span class="s2">                FROM files AS f</span>
<span class="s2">                JOIN replicas AS r ON f.file_path = r.file_path</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting records for files:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status:&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Error listing files.&quot;</span>
                <span class="p">}</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Listing files&quot;</span><span class="p">,</span>
            <span class="s2">&quot;files&quot;</span><span class="p">:</span>    <span class="n">result</span>
            <span class="p">}</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_list_all_clients">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_list_all_clients">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_list_all_clients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lists all clients in the DFS. For root clients use only.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            token (str):    The token of the requestor.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict:           A dictionary with the status and the list of clients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Get the client&#39;s role from the token.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Error listing clients. Corrupted token.&quot;</span>
                <span class="p">}</span>
        
        <span class="n">role</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
        
        <span class="c1"># Check the role of the client.</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Error listing clients. Only admin can list clients.&quot;</span>
                <span class="p">}</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get the metadata of all clients in the DFS.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT username, is_online</span>
<span class="s2">                FROM users</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting records for clients:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status:&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Error listing clients.&quot;</span>
                <span class="p">}</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Listing clients&quot;</span><span class="p">,</span>
            <span class="s2">&quot;clients&quot;</span><span class="p">:</span>  <span class="n">result</span>
            <span class="p">}</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_list_all_file_servers">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_list_all_file_servers">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_list_all_file_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lists all file servers in the DFS. For root clients use only.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            token (str):    The token of the requestor.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            dict:           A dictionary with the status and the list of file servers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Get the client&#39;s role from the token.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Error listing file servers. Corrupted token.&quot;</span>
                <span class="p">}</span>
        
        <span class="n">role</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
        
        <span class="c1"># Check the role of the client.</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span>   <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Error listing file servers. Only admin can list file servers.&quot;</span>
                <span class="p">}</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Get the metadata of all file servers in the DFS.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT name, is_online, address, port, size, free_space</span>
<span class="s2">                FROM file_servers</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting records for file servers:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status:&quot;</span><span class="p">:</span>  <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span>  <span class="s2">&quot;Error listing file servers.&quot;</span>
                <span class="p">}</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span>       <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span>      <span class="s2">&quot;Listing file servers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;file_servers&quot;</span><span class="p">:</span> <span class="n">result</span>
            <span class="p">}</span></div>

    
    
    <span class="c1">##### PERIODIC JOBS AND HEARTBEATS HANDLING #####</span>
    
    
<div class="viewcode-block" id="NameServerService.exposed_receive_activity_heartbeat">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_receive_activity_heartbeat">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_receive_activity_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the heartbeat timestamp of a client or file server.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            token (str):    The token of the requestor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Get the requestor&#39;s username and role from the token.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error updating heartbeat. Corrupted token.&quot;</span>
        
        <span class="n">username</span>    <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        <span class="n">role</span>        <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
        
        <span class="n">conn</span>        <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>      <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># If the requestor is a file server, update its last heartbeat.</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;file_server&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE file_servers</span>
<span class="s2">                    SET last_heartbeat = datetime(&#39;now&#39;)</span>
<span class="s2">                    WHERE name = ?  </span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating record for file server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Else the requestor is a client, so update its last heartbeat.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE users</span>
<span class="s2">                    SET last_heartbeat = datetime(&#39;now&#39;)</span>
<span class="s2">                    WHERE username = ?  </span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">username</span><span class="p">,)</span>
                    <span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating record for client:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span></div>

    
    
<div class="viewcode-block" id="NameServerService.exposed_handle_file_inconsistency">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.exposed_handle_file_inconsistency">[docs]</a>
    <span class="k">def</span> <span class="nf">exposed_handle_file_inconsistency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes actions to handle a file inconsistency found in a file server.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            token (str):        The JWT token of the file server.</span>
<span class="sd">            file_path (str):    The path of the file in the DFS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Get the requestor&#39;s username and role from the token.</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_token_payload</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_public_key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error handling file inconsistency. Corrupted token.&quot;</span>
        
        <span class="n">role</span>    <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
        <span class="n">name</span>    <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        
        <span class="c1"># DEBUG</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handling file inconsistency for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; on file server &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Verify the requestor is a file server.</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">!=</span> <span class="s2">&quot;file_server&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error handling file inconsistency. Requestor is not a file server.&quot;</span>
        
        <span class="c1">### Handle the inconsistency.</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Select the primary file server for the file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT primary_server</span>
<span class="s2">                FROM files</span>
<span class="s2">                WHERE file_path = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">primary_server</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting primary server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error getting the primary serfer for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        
        <span class="c1"># If the requestor was not the primary file server for the file, just</span>
        <span class="c1"># remove the replica from the database.</span>
        <span class="c1"># If the requestor was the primary file server for the file, remove the</span>
        <span class="c1"># replica from the database then try to find a new primary file server.</span>
        
        <span class="c1"># Basically, we need to delete the replica in any way.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                DELETE FROM replicas</span>
<span class="s2">                WHERE file_path = ? AND server = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting replica:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error removing replica for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        
        <span class="c1"># If the requestor was not the primary server for the file, just return.</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">primary_server</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Replica for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; removed successfully.&quot;</span>
        
        <span class="c1"># First, try to find a new primary file server among online file servers.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT fs.name</span>
<span class="s2">                FROM files AS f</span>
<span class="s2">                JOIN replicas AS r ON f.file_path = r.file_path</span>
<span class="s2">                JOIN file_servers AS fs ON r.server = fs.name</span>
<span class="s2">                WHERE fs.is_online = 1</span>
<span class="s2">                AND f.file_path = ?</span>
<span class="s2">                LIMIT 1</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">new_primary_server</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting new primary server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error getting the new primary serfer for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        
        <span class="c1"># If an online file server was found, update the primary server for</span>
        <span class="c1"># the file.</span>
        <span class="k">if</span> <span class="n">new_primary_server</span><span class="p">:</span>
            <span class="c1"># Get the name of the new primary file server (query result is a tuple).</span>
            <span class="n">new_primary_server</span> <span class="o">=</span> <span class="n">new_primary_server</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># DEBUG</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New primary server (online):&quot;</span><span class="p">,</span> <span class="n">new_primary_server</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE files</span>
<span class="s2">                    SET primary_server = ?</span>
<span class="s2">                    WHERE file_path = ?</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">new_primary_server</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Primary server for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; updated successfully.&quot;</span>
            
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating primary server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error updating the primary server for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># If no online file server was found, try to find one offline.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT fs.name</span>
<span class="s2">                FROM files AS f</span>
<span class="s2">                JOIN replicas AS r ON f.file_path = r.file_path</span>
<span class="s2">                JOIN file_servers AS fs ON r.server = fs.name</span>
<span class="s2">                WHERE fs.is_online = 0</span>
<span class="s2">                AND f.file_path = ?</span>
<span class="s2">                LIMIT 1</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">new_primary_server</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting new primary server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error getting the new primary serfer for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        
        <span class="c1"># If an offline primary file server was found, update the primary server</span>
        <span class="c1"># for the file.</span>
        <span class="k">if</span> <span class="n">new_primary_server</span><span class="p">:</span>
            <span class="c1"># Get the name of the new primary file server (query result is a tuple).</span>
            <span class="n">new_primary_server</span> <span class="o">=</span> <span class="n">new_primary_server</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># DEBUG</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New primary server (offline):&quot;</span><span class="p">,</span> <span class="n">new_primary_server</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    UPDATE files</span>
<span class="s2">                    SET primary_server = ?</span>
<span class="s2">                    WHERE file_path = ?</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">new_primary_server</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Primary server for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; updated successfully.&quot;</span>
            
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>    
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating primary server:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error updating the primary server for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Eventually, if no new primary file server was found, mark the file as</span>
        <span class="c1"># corrupted.</span>
        
        <span class="c1"># DEBUG</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No new primary server found. Marking file as corrupted...&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE files</span>
<span class="s2">                SET is_corrupted = 1</span>
<span class="s2">                WHERE file_path = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; marked as corrupted successfully.&quot;</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error marking file as corrupted:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error marking file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; as corrupted&quot;</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
    <span class="c1">##### PERIODIC JOBS #####</span>
    
    
<div class="viewcode-block" id="NameServerService.periodic_replication_job">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.periodic_replication_job">[docs]</a>
    <span class="k">def</span> <span class="nf">periodic_replication_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Periodically replicates the files in the DFS up to K times.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            K (int):    The number of times to replicate the files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># TEST: replicazione di file con primary server offline.</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">()</span><span class="si">}</span><span class="s2">] Replicating files...&quot;</span><span class="p">)</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Select the files that need to be replicated (IE those that have less than</span>
        <span class="c1"># K online replicas) and their primary server.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT </span>
<span class="s2">                    f.file_path,</span>
<span class="s2">                    COUNT(r.server) as active_replicas</span>
<span class="s2">                FROM files AS f</span>
<span class="s2">                JOIN replicas AS r ON f.file_path = r.file_path</span>
<span class="s2">                JOIN file_servers AS fs ON r.server = fs.name</span>
<span class="s2">                WHERE fs.is_online = 1</span>
<span class="s2">                GROUP BY f.file_path</span>
<span class="s2">                HAVING active_replicas &lt; ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">files_to_replicate</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting records for replication:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span>
        
        <span class="c1"># If there are no files to replicate, return.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files_to_replicate</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span>
        
        <span class="c1"># For every file that needs to be replicated.</span>
        <span class="k">for</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">active_replicas</span> <span class="ow">in</span> <span class="n">files_to_replicate</span><span class="p">:</span>
            
            <span class="c1"># Select address and port of the primary server.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT address, port</span>
<span class="s2">                    FROM file_servers AS fs</span>
<span class="s2">                    JOIN files AS f ON fs.name = f.primary_server</span>
<span class="s2">                    WHERE f.file_path = ?</span>
<span class="s2">                    AND fs.is_online = 1</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">primary_server</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting record:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
                <span class="k">return</span>
            
            <span class="c1"># If the primary server is offline, continue.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_server</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File server is offline. Skipping file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                
                <span class="k">continue</span>
            
            <span class="c1"># Select address and port of online file servers which don&#39;t have the</span>
            <span class="c1"># file, up to (K - active_replicas). Those servers must be different</span>
            <span class="c1"># from those that already have the file.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT fs.name, fs.address, fs.port</span>
<span class="s2">                    FROM file_servers AS fs</span>
<span class="s2">                    WHERE fs.name NOT IN (</span>
<span class="s2">                        SELECT server</span>
<span class="s2">                        FROM replicas</span>
<span class="s2">                        JOIN files ON replicas.file_path = files.file_path</span>
<span class="s2">                        WHERE files.file_path = ?</span>
<span class="s2">                        )</span>
<span class="s2">                    AND fs.is_online = 1</span>
<span class="s2">                    LIMIT ?</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">K</span> <span class="o">-</span> <span class="n">active_replicas</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">file_servers</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting record for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
                <span class="k">return</span>
            
            <span class="c1"># If no file servers are available, continue.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_servers</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No file servers available. Skipping replication for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Send file servers&#39; coordinates to the primary server if possible,</span>
                <span class="c1"># so that it can send them the file.</span>
                <span class="c1"># Try to connect to the primary server.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">server</span> <span class="o">=</span> <span class="n">rpyc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">primary_server</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">primary_server</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">server</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">send_file_replicas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">file_servers</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replication job for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; completed.&quot;</span><span class="p">)</span>
                
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to connect to primary server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    
                    <span class="k">return</span>
            
            <span class="c1"># Update the replicas table.</span>
            <span class="k">for</span> <span class="n">file_server</span> <span class="ow">in</span> <span class="n">file_servers</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        INSERT INTO replicas (file_path, server)</span>
<span class="s2">                        VALUES (?, ?)</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">file_server</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="p">)</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                
                <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inserting record for file &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    
                    <span class="k">return</span>
        
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
<div class="viewcode-block" id="NameServerService.periodic_check_activity">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.periodic_check_activity">[docs]</a>
    <span class="k">def</span> <span class="nf">periodic_check_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hb_timeout</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Periodically checks the activity of the other entities in the DFS.</span>
<span class="sd">        Updates the status of the file servers and users if they haven&#39;t sent</span>
<span class="sd">        a heartbeat in the last hb_timeout seconds.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            hb_timeout (int):   The maximum time since the last heartbeat.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># NOTE: sebbene sia stata implementata la disconnessione logica sul database</span>
        <span class="c1">#       in ogni client e file server, è possibile che il name server venga</span>
        <span class="c1">#       disconnesso in modo improvviso prima che le altre componenti possano</span>
        <span class="c1">#       a loro volta disconnettersi in modo sicuro. In casi come questo,</span>
        <span class="c1">#       clients e file servers permangono nel database come connessi.</span>
        <span class="c1">#       Il presente meccanismo forza la disconnessione logica (su database)</span>
        <span class="c1">#       di tutti i clients e file servers che non hanno inviato un heartbeat</span>
        <span class="c1">#       nel periodo definito.</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">()</span><span class="si">}</span><span class="s2">] Checking system entities activity...&quot;</span><span class="p">)</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Update the status in the file servers table.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE file_servers</span>
<span class="s2">                SET is_online = 0</span>
<span class="s2">                WHERE is_online = 1</span>
<span class="s2">                AND (strftime(&#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;now&#39;) - strftime(&#39;</span><span class="si">%s</span><span class="s2">&#39;, last_heartbeat)) &gt; ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">hb_timeout</span><span class="p">,</span> <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating file servers status:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span>
        
        <span class="c1"># Update the status in the users table.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE users</span>
<span class="s2">                SET is_online = 0</span>
<span class="s2">                WHERE is_online = 1</span>
<span class="s2">                AND (strftime(&#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;now&#39;) - strftime(&#39;</span><span class="si">%s</span><span class="s2">&#39;, last_heartbeat)) &gt; ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">hb_timeout</span><span class="p">,</span> <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating users status:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span>
        
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    
    
<div class="viewcode-block" id="NameServerService.periodic_trigger_garbage_collection">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.periodic_trigger_garbage_collection">[docs]</a>
    <span class="k">def</span> <span class="nf">periodic_trigger_garbage_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Periodically sends to the name server the list of files that are needed, so</span>
<span class="sd">        that it can delete those files and directories that are not needed anymore.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">()</span><span class="si">}</span><span class="s2">] Triggering garbage collection on active file servers...&quot;</span><span class="p">)</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Select all the file servers that are online.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT name, address, port</span>
<span class="s2">                FROM file_servers</span>
<span class="s2">                WHERE is_online = 1</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">file_servers</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting record for online file servers:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span>
        
        <span class="c1"># For every online file server.</span>
        <span class="k">for</span> <span class="n">file_server</span> <span class="ow">in</span> <span class="n">file_servers</span><span class="p">:</span>
            
            <span class="c1"># Select all the files that are stored in that node, according to the</span>
            <span class="c1"># database.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT file_path</span>
<span class="s2">                    FROM replicas</span>
<span class="s2">                    WHERE server = ?</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">file_server</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting record for replicas:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
                <span class="k">return</span>
            
            <span class="c1"># If there are no files for this file server, continue.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Send the files to the file server.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">server</span> <span class="o">=</span> <span class="n">rpyc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">file_server</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">file_server</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">server</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">garbage_collection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
            
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to connect to file server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
                <span class="k">return</span>
        
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span></div>

    
    
<div class="viewcode-block" id="NameServerService.periodic_trigger_consistency_check">
<a class="viewcode-back" href="../NameServer.html#NameServer.NameServerService.periodic_trigger_consistency_check">[docs]</a>
    <span class="k">def</span> <span class="nf">periodic_trigger_consistency_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Periodically sends to the active file servers the files they should have</span>
<span class="sd">        and their checksums, so that they can check the consistency of the files</span>
<span class="sd">        they store.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">()</span><span class="si">}</span><span class="s2">] Triggering consistency check on active file servers...&quot;</span><span class="p">)</span>
        
        <span class="n">conn</span>    <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">)</span>
        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        
        <span class="c1"># Select all the file servers that are online.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT name, address, port</span>
<span class="s2">                FROM file_servers</span>
<span class="s2">                WHERE is_online = 1</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">file_servers</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting online file servers:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span>
        
        <span class="c1"># For every online file server.</span>
        <span class="k">for</span> <span class="n">file_server</span> <span class="ow">in</span> <span class="n">file_servers</span><span class="p">:</span>
            
            <span class="c1"># Select all the files that are stored in that node and their checksums,</span>
            <span class="c1"># according to the database.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT f.file_path, f.checksum</span>
<span class="s2">                    FROM replicas AS r</span>
<span class="s2">                    JOIN files AS f ON r.file_path = f.file_path</span>
<span class="s2">                    WHERE r.server = ?</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">file_server</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error selecting replicas:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                
                <span class="k">return</span>
            
            <span class="c1"># If there are no files for this file server, continue.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Send the files to the file server.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">server</span> <span class="o">=</span> <span class="n">rpyc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">file_server</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">file_server</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">server</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">consistency_check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
            
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to connect to file server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
                <span class="k">return</span>
        
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>




<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Welcome to sym-DFS Project Server.&quot;</span><span class="p">)</span>
    
    <span class="c1">### Name server creation.</span>
    <span class="n">name_server</span> <span class="o">=</span> <span class="n">NameServerService</span><span class="p">()</span>
    
    <span class="c1">### Job scheduling.</span>
    
    <span class="c1"># NOTE: per ora lo scheduler non è un attributo del name server, perché</span>
    <span class="c1">#       non è necessario eseguire un controllo dinamico.</span>
    
    <span class="n">scheduler</span>   <span class="o">=</span> <span class="n">BackgroundScheduler</span><span class="p">()</span>   <span class="c1"># Job scheduler.</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting periodic replication job...&quot;</span><span class="p">)</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
        <span class="n">name_server</span><span class="o">.</span><span class="n">periodic_replication_job</span><span class="p">,</span>
        <span class="n">args</span>    <span class="o">=</span> <span class="p">[</span><span class="n">K_REPLICAS</span><span class="p">],</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="s1">&#39;interval&#39;</span><span class="p">,</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">PR_TIMEOUT</span>
        <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting periodic check activity job...&quot;</span><span class="p">)</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
        <span class="n">name_server</span><span class="o">.</span><span class="n">periodic_check_activity</span><span class="p">,</span>
        <span class="n">args</span>    <span class="o">=</span> <span class="p">[</span><span class="n">HB_TIMEOUT</span><span class="p">],</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="s1">&#39;interval&#39;</span><span class="p">,</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">HB_TIMEOUT</span>
        <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting periodic garbage collection job...&quot;</span><span class="p">)</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
        <span class="n">name_server</span><span class="o">.</span><span class="n">periodic_trigger_garbage_collection</span><span class="p">,</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="s1">&#39;interval&#39;</span><span class="p">,</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">GC_TIMEOUT</span>
    <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting periodic consistency check job...&quot;</span><span class="p">)</span>
    <span class="n">scheduler</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
        <span class="n">name_server</span><span class="o">.</span><span class="n">periodic_trigger_consistency_check</span><span class="p">,</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="s1">&#39;interval&#39;</span><span class="p">,</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">CC_TIMEOUT</span>
    <span class="p">)</span>
    
    <span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    
    <span class="c1">### Name server start.</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">ThreadedServer</span><span class="p">(</span>
        <span class="n">name_server</span><span class="p">,</span>
        <span class="n">hostname</span>    <span class="o">=</span> <span class="n">name_server</span><span class="o">.</span><span class="n">server_host</span><span class="p">,</span>
        <span class="n">port</span>        <span class="o">=</span> <span class="n">name_server</span><span class="o">.</span><span class="n">server_port</span>
        <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting name server...&quot;</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">sym-DFS-project</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Carlo Uguzzoni.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>